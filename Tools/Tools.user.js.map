{"version":3,"file":"Tools.user.js","sources":["Tools.user.ts"],"sourcesContent":["// ==UserScript==\n// @name         Tools\n// @namespace    Paul-16098\n// @description  paul Tools\n// @version      2.2.14.0\n// @match        *://*/*\n// @author       paul\n// @license      MIT\n// @grant        GM_getValue\n// @run-at       document-start\n// @grant        unsafeWindow\n// @supportURL   https://github.com/Paul-16098/vs_code/issues/\n// @homepageURL  https://github.com/Paul-16098/vs_code/blob/main/js/userjs/README.md\n// @downloadURL  https://github.com/Paul-16098/vs_code/raw/main/js/userjs/Tools.user.js\n// @updateURL    https://github.com/Paul-16098/vs_code/raw/main/js/userjs/Tools.user.js\n// ==/UserScript==\n\n// 避免重複宣告 _unsafeWindow\nconst _unsafeWindow = unsafeWindow ?? window;\n\nconst IS_DEBUG_LOG: boolean = GM_getValue(\"IS_DEBUG_LOG\", false);\n\n/**\n * 初始化 GM API 代理，兼容不同腳本管理器環境。\n * 會自動偵測可用的 GM_* API，並設置對應的變數。\n * 若無法取得則提供降級方案。\n */\nfunction setGM() {\n  let debug = console.debug;\n  {\n    // 初始化 GM API 相關的方法和信息\n    var _GM_xmlhttpRequest: Function,\n      _GM_registerMenuCommand: Function,\n      _GM_notification: Function,\n      _GM_addStyle: Function,\n      _GM_openInTab: Function,\n      _GM_info: object,\n      _GM_setClipboard: Function;\n    {\n      // 處理 GM_xmlhttpRequest\n      if (typeof GM_xmlhttpRequest !== \"undefined\") {\n        _GM_xmlhttpRequest = GM_xmlhttpRequest;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.xmlHttpRequest !== \"undefined\"\n      ) {\n        _GM_xmlhttpRequest = GM.xmlHttpRequest;\n      } else {\n        _GM_xmlhttpRequest = (f: {\n          url: string | URL | Request;\n          method: any;\n          data: any;\n          headers: any;\n          onload: (arg0: { response: string }) => any;\n          onerror: () => any;\n        }) => {\n          fetch(f.url, {\n            method: f.method || \"GET\",\n            body: f.data,\n            headers: f.headers,\n          })\n            .then((response) => response.text())\n            .then((data) => {\n              f.onload && f.onload({ response: data });\n            })\n            .catch(f.onerror && f.onerror());\n        };\n      }\n    }\n    {\n      // 處理 GM_registerMenuCommand\n      if (typeof GM_registerMenuCommand !== \"undefined\") {\n        _GM_registerMenuCommand = GM_registerMenuCommand;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.registerMenuCommand !== \"undefined\"\n      ) {\n        _GM_registerMenuCommand = GM.registerMenuCommand;\n      } else {\n        _GM_registerMenuCommand = (s: any, f: any) => {\n          debug(s);\n          debug(f);\n        };\n      }\n    }\n    {\n      // 處理 GM_info\n      if (typeof GM_info !== \"undefined\") {\n        _GM_info = GM_info;\n      } else if (typeof GM !== \"undefined\" && typeof GM.info !== \"undefined\") {\n        _GM_info = GM.info;\n      } else {\n        _GM_info = { script: {} };\n      }\n    }\n    {\n      // 處理 GM_notification\n      if (typeof GM_notification !== \"undefined\") {\n        _GM_notification = GM_notification;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.notification !== \"undefined\"\n      ) {\n        _GM_notification = GM.notification;\n      } else {\n        _GM_notification = (s: { text: any }) => {\n          alert(\"_GM_notification: \" + String(s.text || s));\n        };\n      }\n    }\n    {\n      // 處理 GM_openInTab\n      if (typeof GM_openInTab !== \"undefined\") {\n        _GM_openInTab = GM_openInTab;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.openInTab !== \"undefined\"\n      ) {\n        _GM_openInTab = GM.openInTab;\n      } else {\n        _GM_openInTab = (s: string | URL | undefined, t: any) => {\n          window.open(s);\n          debug(t);\n        };\n      }\n    }\n    {\n      // 處理 GM_addStyle\n      if (typeof GM_addStyle !== \"undefined\") {\n        _GM_addStyle = GM_addStyle;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.addStyle !== \"undefined\"\n      ) {\n        _GM_addStyle = GM.addStyle;\n      } else {\n        _GM_addStyle = (CssStr: string) => {\n          let styleEle = document.createElement(\"style\");\n          styleEle.classList.add(\"_GM_addStyle\");\n          styleEle.innerHTML = CssStr;\n          document.head.appendChild(styleEle);\n          return styleEle;\n        };\n      }\n    }\n    {\n      // 處理 GM_setClipboard\n      if (typeof GM_setClipboard !== \"undefined\") {\n        _GM_setClipboard = GM_setClipboard;\n      } else if (\n        typeof GM !== \"undefined\" &&\n        typeof GM.setClipboard !== \"undefined\"\n      ) {\n        _GM_setClipboard = GM.setClipboard;\n      } else {\n        _GM_setClipboard = (s: any, i: any) => {\n          debug(s);\n          debug(i);\n        };\n      }\n    }\n  }\n}\n\n/**\n * 從 DOM 中移除指定選擇器的所有元素。\n * @param args - CSS 選擇器字串陣列\n * @returns [true, args] 或 [false, args, error]\n */\nfunction removeElement(...args: Array<string>) {\n  try {\n    if (args) {\n      args.forEach((args) => {\n        if (IS_DEBUG_LOG) {\n          console.log(\"args: \", args);\n          console.log(\n            \"document.querySelectorAll(args): \",\n            document.querySelectorAll(args)\n          );\n        }\n        if (document.querySelectorAll(args).length !== 0) {\n          document.querySelectorAll(args).forEach((ele) => {\n            ele.remove();\n          });\n        } else {\n          console.debug(args, \"is not a Html Element.\");\n        }\n      });\n    }\n  } catch (e) {\n    console.error(e);\n    return [false, args, e];\n  }\n  return [true, args];\n}\n\ntype setMenuFn = (ev?: MouseEvent | KeyboardEvent) => void;\n/**\n * 註冊一個用戶菜單命令，支援布林值自動切換與自定義顯示。\n *\n * @param name - 設定名稱（同時作為 GM 存儲 key）\n * @param fn - (可選) 點擊時執行的函數，若為布林值預設為切換並重載\n * @param def - (可選) 預設值\n * @param showMapping - (可選) 顯示映射表\n * @returns 菜單命令ID\n *\n * @remarks\n * - 如果值為 `name` 是未定義的，且提供了 `def`，則將 `def` 設置為初始值。\n * - 對於布林值，菜單會顯示切換選項，並在變更時重新加載頁面。\n * - 對於不支持的類型，當選擇菜單項時會記錄錯誤。\n */\nfunction setMenu(\n  name: string,\n  fn?: setMenuFn,\n  def?: any,\n  showMapping?: { [x: string]: string } | undefined\n): number {\n  // 顯示值的映射\n  const trueShowMapping: { [x: string]: string } = {\n    true: \"開\",\n    false: \"關\",\n    ...(showMapping ?? {}),\n  };\n  let support = false;\n  let showName: string = trueShowMapping[name] ?? name.replaceAll(\"_\", \" \");\n  let getValue: any = GM_getValue(name);\n  let showValue: string = \"No support\";\n  if (getValue === undefined && def !== undefined) {\n    // 如果沒有值，則使用默認值\n    GM_setValue(name, def);\n    getValue = def;\n    console.debug(`setMenu: ${name} set default value: ${def}`);\n  }\n  if (typeof getValue === \"boolean\") {\n    support = true;\n    showValue = getValue.toString();\n  }\n  showValue = trueShowMapping[getValue] ?? showValue;\n\n  const trueFn =\n    fn ??\n    (support\n      ? function (ev: MouseEvent | KeyboardEvent) {\n          if (typeof getValue === \"boolean\") {\n            GM_setValue(name, !getValue);\n            window.location.reload();\n          }\n        }\n      : () => {\n          let t = \"the type is not supported: \" + typeof getValue;\n          // alert(t);\n          console.error(t);\n        });\n\n  return GM_registerMenuCommand(`${showName}: ${showValue}`, trueFn);\n}\n\n/**\n * 安全執行傳入的字串代碼，支援黑名單過濾。\n * @param stringCode - 要執行的代碼\n * @param safety - 是否啟用安全過濾\n * @returns 執行結果\n * @throws 若包含黑名單關鍵字則丟出錯誤\n */\nfunction newEval(stringCode: string, safety: boolean = true) {\n  // 檢查是否包含不允許的關鍵字或代碼\n  const blackList: Array<string | RegExp> = [\n    \"eval\", // 防止執行惡意代碼\n    \"function\", // 防止構造新的函數對象\n    \"let\",\n    \"var\", // 防止變量聲明\n    \"document\", // 防止 DOM 操作\n    \"alert\", // 防止彈窗\n    \"navigator\", // 防止獲取瀏覽器相關信息\n    \"localStorage\",\n    \"sessionStorage\", // 防止訪問瀏覽器的存儲\n    \"console\", // 防止使用 console.log 或其他控制枱方法\n    \"XMLHttpRequest\",\n    \"fetch\", // 防止發起網絡請求\n    \"import\",\n    \"export\", // 防止模塊導入和導出\n    \"async\",\n    \"await\", // 防止定義異步函數\n    \"with\", // 防止使用 with 語句\n    \"Promise\", // 防止使用 Promise，可能導致複雜的異步操作\n    /window\\.[0-9a-zA-Z_]+ *=/, // 檢查對 window 對象的屬性賦值\n  ];\n  if (safety) {\n    // 遍歷不允許的字元或代碼列表\n    for (const value of blackList) {\n      if (typeof value === \"string\") {\n        if (stringCode.includes(value)) {\n          throw new Error(\n            `不允許的關鍵字或代碼: ${JSON.stringify(\n              value\n            )},在代碼: ${stringCode}`\n          );\n        }\n      } else if (value instanceof RegExp) {\n        if (value.test(stringCode)) {\n          throw new Error(\n            `不允許的關鍵字或代碼: ${value},在代碼: ${stringCode}`\n          );\n        }\n      }\n    }\n  }\n  // 返回執行傳入字符串代碼的結果\n  return new Function(`${safety ? \"return\" : \"\"} ${stringCode}`)();\n}\n\n// #region i18n\n\n/**\n * 多語系(i18n)工具類，支援多語言字典與動態參數替換。\n */\nclass i18n {\n  /** 語言字典資料 */\n  public langJson: {\n    [lang: string]: {\n      [key: string]: string;\n    };\n  };\n  /** 語言優先順序列表 */\n  langList: Array<string> = [];\n\n  /**\n   * 建構子\n   * @param langJson - 語言字典\n   * @param lang - 語言代碼或語言代碼陣列\n   */\n  constructor(langJson: typeof this.langJson, lang: string | Array<string>) {\n    // 構造函數，接受語言和語言映射\n    this.langJson = langJson;\n    if (lang instanceof Array) {\n      // 如果傳入的是數組\n      this.langList.push(...lang);\n    } else if (typeof lang === \"string\") {\n      // 如果傳入的是單個語言\n      this.langList.push(lang);\n    }\n  }\n\n  /**\n   * 取得本地化字串，支援參數替換。\n   * @param key - 字典鍵值\n   * @param args - 參數\n   * @returns 對應語言的字串，若無則回傳key\n   */\n  public get(\n    key: keyof (typeof this.langJson)[keyof typeof this.langJson],\n    ...args: Array<any>\n  ): string {\n    for (const lang of this.langList) {\n      // 遍歷語言列表\n      if (this.langJson[lang] && this.langJson[lang][key]) {\n        // 檢查語言映射中是否存在該鍵\n        let text = this.langJson[lang][key]; // 獲取對應的語言文本\n        if (args && args.length > 0) {\n          // 如果傳入了參數\n          text = text.replace(/{(\\d+)}/g, (match, number) => {\n            if (number >= 0 && number < args.length) {\n              // 替換文本中的 {n} 參數\n              return typeof args[number] === \"undefined\" ? match : args[number];\n            }\n            return match;\n          });\n        }\n        return text;\n      }\n    }\n    console.warn(`Translation missing for key: \"${key}\"`); // 警告缺少的翻譯\n    return String(key); // 如果沒有找到對應的翻譯，返回key本身\n  }\n  /**\n   * 別名，等同 get\n   */\n  public t = this.get;\n}\n// #endregion i18n\n"],"names":["unsafeWindow","window","GM_getValue"],"mappings":";;;EACA;EACsBA,YAAAA,EAAgBC,OAERC,WAAAA,CAAY,eAAgB,KAAA;;;;;;"}