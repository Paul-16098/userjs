// @license      MIT
"use strict";var Language=/*#__PURE__*/function(Language){Language["en"]="en";Language["zh"]="zh";return Language}(Language||{});class Config{Debug=GM_getValue("Debug",false);IsEndClose=GM_getValue("IsEndClose",true);AutoAddBookcase=GM_getValue("AutoAddBookcase",true);AutoAddBookcaseBlockade=GM_getValue("AutoAddBookcaseBlockade",[]);IsHookAlert=GM_getValue("IsHookAlert",true);HookAlertBlockade=GM_getValue("HookAlertBlockade",[["添加成功"],["刪除成功!"],["恭喜您，该章节已经加入到您的书签！"]]);Language=GM_getValue("Language","zh");constructor(){this.set();this.registerConfigMenu();return this}registerConfigMenu(){for(const key in this){const value=this[key];let menu=undefined;if(Object.values(Language).includes(value)){menu=()=>{Object.values(Language).forEach(lang=>{if(lang!==value){GM_setValue("Language",lang);location.reload()}})}}setMenu(key,menu,value,{zh:"中文",en:"english",Debug:"偵錯",AutoAddBookcase:"自動添加書櫃",AutoAddBookcaseBlockade:"自動添加書櫃封鎖",Language:"語言",IsEndClose:"結束後關閉",IsHookAlert:"掛鉤Alert",HookAlertBlockade:"掛鉤Alert封鎖"})}}set(){GM_setValue("Debug",this.Debug);GM_setValue("IsEndClose",this.IsEndClose);GM_setValue("AutoAddBookcase",this.AutoAddBookcase);GM_setValue("AutoAddBookcaseBlockade",this.AutoAddBookcaseBlockade);GM_setValue("IsHookAlert",this.IsHookAlert);GM_setValue("HookAlertBlockade",this.HookAlertBlockade);GM_setValue("Language",this.Language)}}const config=new Config;const i18nData={en:{noMatchingPattern:"No matching URL pattern found",errorOccurred:"An error occurred: ",noLabelsFound:"No labels found, retrying in 5 seconds...",maxRetriesReached:"Max retries reached. No labels found.",noUpdates:"No updates",updatesAvailable:" updates available"},zh:{noMatchingPattern:"未找到匹配的 URL 模式",errorOccurred:"發生了一些錯誤: ",noLabelsFound:"未找到標籤，5 秒後重試...",maxRetriesReached:"已達到最大重試次數。未找到標籤。",noUpdates:"沒有更新",updatesAvailable:"個更新"}};const i18nInstance=new i18n(i18nData,config.Language);const t=i18nInstance.t;class BookManager{SELECTORS={nextPage:["body > div.container > div.mybox > div.page1 > a:nth-child(4)","body > div.mainbox > div > div.page1 > a:nth-child(4)"],authorInfo:"body > div.container > div.mybox > div.txtnav > div.txtinfo.hide720 > span:nth-child(2)",titleDiv:"body > div.container > div.mybox > div.tools",searchInput:"body > header > div > form > div > div.inputbox > input[type=text]",searchForm:"body > header > div > form"};data={HasBookInfo:typeof bookinfo!=="undefined",IsBookshelf:(href=location.href)=>{if(this.data.IsTwkan){return new URL(href).pathname==="/bookcase"}else{return new URL(href).pathname==="/modules/article/bookcase.php"}},Book:{GetAid:(href=window.location.href)=>{if(this.data.HasBookInfo){return bookinfo.articleid}return href.split("/")[4]},GetCid:(href=window.location.href)=>{if(this.data.HasBookInfo){return bookinfo.chapterid}return href.split("/")[5]},pattern:/^\/(txt|c|r)\/([0-9]|[a-z])+\/([0-9]|[a-z])+(\.html)?$/m,Is:(href=window.location.href)=>{return this.data.Book.pattern.test(new URL(href).pathname)}},Info:{pattern:/^\/(book|b|article)\/([0-9]|[a-z])+\.htm(l)?$/m,Is:(pathname=window.location.pathname)=>{return this.data.Info.pattern.test(pathname)}},End:{Is:(href=window.location.href)=>{if(this.data.Info.Is()){const searchParams=new URL(href).searchParams;return searchParams.get("FromBook")==="true"}if(this.data.IsTwkan){let h=new URL(href);if(/txt\/[0-9]+\/end\.html/.test(h.pathname)&&h.searchParams.get("FromBook")==="true"){return true}else{return false}}return false}},GetNextPageUrl:()=>{const nextPageEle=this.getNextPageElement();return nextPageEle?.href},IsNextEnd:()=>{if(this.data.Book.Is()){const nextUrl=this.data.GetNextPageUrl();if(nextUrl){return this.data.End.Is(nextUrl)||this.data.Info.Is(new URL(nextUrl).pathname)}}return false},IsBiz:location.host==="69shu.biz",IsTwkan:location.host==="twkan.com"};getNextPageElement(){for(const selector of this.SELECTORS.nextPage){const element=document.querySelector(selector);if(element&&element.href)return element}return Array.from(document.querySelectorAll("a")).find(link=>link.textContent==="下一章")}constructor(){try{if(config.Debug){console.debug(this.debugInfo())}const search=new URLSearchParams(location.search).get("q");if(search)this.performSearch(search);if(this.data.End.Is()){if(config.Debug)console.log("End page detected");if(config.IsEndClose)window.close()}if(this.data.Book.Is()){if(config.Debug)console.log("Book page detected");this.handleBookPage()}if(this.data.Info.Is()){if(config.Debug)console.log("Book info page detected");let Ele=document.querySelector("body > div.container > ul > li.col-8 > div:nth-child(2) > ul > li:nth-child(2) > a");if(Ele){Ele.click()}}if(this.data.IsBookshelf()){if(config.Debug)console.log("Bookshelf page detected");this.handleBookshelf()}if(!this.data.Book.Is()&&!this.data.Info.Is()&&!this.data.End.Is()&&!this.data.IsBookshelf()){if(!config.Debug){alert(t("noMatchingPattern"))}}}catch(error){console.error(error);if(!config.Debug){alert(`${t("errorOccurred")}${String(error)}`)}}}handleBookPage(){if(config.IsHookAlert)this.hookAlert();this.addStyles();this.modifyPageNavigation();removeElement(".mytitle",".top_Scroll","#pagefootermenu","body > div.container > div > div.yueduad1","#pageheadermenu",".bottom-ad2","body > div.container > div.yuedutuijian.light");if(this.data.IsTwkan){removeElement("#container > br")}if(config.AutoAddBookcase)this.autoAddToBookcase();this.insertAuthorLink();this.updateNextPageLink();if(this.data.IsTwkan){const raw_replace_json=GM_getResourceText("replace_json");let replace_json={};try{replace_json=JSON.parse(raw_replace_json)}catch(error){if(error instanceof SyntaxError){if(config.Debug){console.log(error)}else{alert(error)}}else{throw error}}if(config.Debug){console.log("replace_json: ",replace_json)}for(const key in replace_json){if(Object.prototype.hasOwnProperty.call(replace_json,key)){const element=replace_json[key];document.querySelector("#txtcontent").innerText=document.querySelector("#txtcontent")?.innerText.replaceAll(key,element)}}}}autoAddToBookcase(){const aid=this.data.Book.GetAid();if(!config.AutoAddBookcaseBlockade.includes(aid)){this.addBookcase()}else{console.log("Book is in the blockade list, not auto adding to bookcase.")}}updateNextPageLink(){const nextPageEle=this.getNextPageElement();if(nextPageEle){const href=new URL(nextPageEle.href);href.searchParams.set("FromBook","true");nextPageEle.href=href.toString()}}hookAlert(){const _alert=alert;unsafeWindow.alert=(...message)=>{if(!config.HookAlertBlockade.some(blockade=>JSON.stringify(message)===JSON.stringify(blockade)||JSON.stringify(blockade)==="*")){_alert(...message)}if(config.Debug)console.log("Alert message:",message)}}addStyles(){const css1=GM_getResourceText("css1");GM_addStyle(css1);if(config.Debug)console.log("CSS added")}modifyPageNavigation(){document.onkeydown=null;addEventListener("keydown",this.keydownHandler.bind(this))}keydownHandler(e){if(!e.repeat&&e.key==="ArrowRight"){const nextPageLink=this.data.GetNextPageUrl();if(nextPageLink){let href=new URL(nextPageLink);href.searchParams.set("FromBook","true");window.location.href=href.toString()}if(this.data.IsNextEnd()){if(config.IsEndClose){window.close()}}}}addBookcase(){const aid=this.data.Book.GetAid();const cid=this.data.Book.GetCid();if(!addbookcase.toString().includes("Ajax.Tip")){addbookcase(aid,cid)}else{const addBookcaseLink=document.querySelector("#a_addbookcase");addBookcaseLink?.click()}}insertAuthorLink(){const author=document.querySelector(this.SELECTORS.authorInfo)?.textContent?.trim().split(" ")[1]??"undefined";const authorLink=this.createAuthorLink(author);const titleDiv=document.querySelector(this.SELECTORS.titleDiv);if(titleDiv){const titleLink=this.createTitleLink();titleDiv.parentNode?.replaceChild(titleLink,titleDiv)}}createAuthorLink(author){const authorLink=document.createElement("a");authorLink.href=`${window.location.origin}/modules/article/author.php?author=${encodeURIComponent(author)}`;authorLink.textContent=author;authorLink.style.color="#007ead";return authorLink}createTitleLink(){const titleLink=document.createElement("a");titleLink.innerHTML=this.data.HasBookInfo?bookinfo.articlename??document.title.split("-")[0]:document.title.split("-")[0];titleLink.classList.add("userjs_add");titleLink.id="title";titleLink.href=`${window.location.origin}/${this.data.IsBiz?"b":"book"}/${this.data.Book.GetAid()}.${this.data.IsBiz||this.data.IsTwkan?"html":"htm"}`;return titleLink}async handleBookshelf(){const bookData=await this.collectBookData();if(config.Debug)console.log("Bookshelf data collected",bookData);this.registerMenuCommand(bookData)}performSearch(search){const searchInput=document.querySelector(this.SELECTORS.searchInput);const searchForm=document.querySelector(this.SELECTORS.searchForm);if(searchInput&&searchForm){searchInput.value=search;searchForm.submit()}}async collectBookData(retryCount=0){const books=[];const labels=document.querySelectorAll("[id^='book_']");if(config.Debug)console.groupCollapsed("collectBookData");if(labels.length===0){if(retryCount<=5){console.warn(t("noLabelsFound"));await new Promise(resolve=>setTimeout(resolve,5e3));return this.collectBookData(retryCount+1)}else{console.error(t("maxRetriesReached"));return[]}}if(config.Debug){console.log(labels)}labels.forEach(label=>{const bookContainer=label;const tmp=function(){if(Array.from(label.querySelectorAll("label")).find(label2=>label2.textContent==="更新")){const bookContinueEle=label.querySelector("div.newright > a.btn.btn-tp");const bookContinueLink=bookContinueEle.href;const BookName=label.querySelector("div.newnav > h3 > a > span").textContent;const bookImgEle=label.querySelector("a > img");const bookImgUrl=bookImgEle.src;return{bookContinueLink,BookName,bookImgUrl}}else{return false}}();if(tmp){const{bookContinueLink,BookName,bookImgUrl}=tmp;const push_data={Updata:{url:{value:bookContinueLink,URLParams:new URLSearchParams(bookContinueLink)}},Mate:{BookName:BookName,BookHtmlObj:bookContainer,BookImgUrl:bookImgUrl}};if(config.Debug){console.group(push_data.Mate.BookName);console.log(push_data.Mate);console.table(push_data.Updata);console.groupEnd()}books.push(push_data)}});if(config.Debug)console.groupEnd();return books}registerMenuCommand(bookData){GM_registerMenuCommand(`${bookData.length===0?t("noUpdates"):`${bookData.length}${t("updatesAvailable")}`}`,()=>{bookData.forEach(data=>{GM_openInTab(data.Updata.url.value)})})}debugInfo(){return{IsBook:this.data.Book.Is(),IsInfo:this.data.Info.Is(),IsEnd:this.data.End.Is(),IsNextEnd:this.data.IsNextEnd(),IsBookshelf:this.data.IsBookshelf(),HasBookinfo:this.data.HasBookInfo,IsBiz:this.data.IsBiz,IsTwkan:this.data.IsTwkan,...config}}}const bookManager=new BookManager;
//# sourceMappingURL=69shuba auto 書簽.user.js.map