{"version":3,"sources":["69shuba auto 書簽.user.ts"],"sourcesContent":["/// <reference path = \"./../Tools/Tools.user.d.ts\" />\r\n// ==UserScript==\r\n// @name         69shuba auto 書簽\r\n// @namespace    Paul-16098\r\n// @version      3.5.13.0\r\n// @description  自動書籤,更改css,可以在看書頁找到作者連結\r\n// @author       Paul-16098\r\n// #tag 69shux.com\r\n// @match        https://69shux.com/txt/*/*\r\n// @match        https://69shux.com/txt/*/end.html\r\n// @match        https://69shux.com/book/*.htm*\r\n// @match        https://69shux.com/modules/article/bookcase.php*\r\n// #tag www.69shu.top\r\n// @match        https://www.69shu.top/txt/*/*\r\n// @match        https://www.69shu.top/txt/*/end.html\r\n// @match        https://www.69shu.top/book/*.htm*\r\n// @match        https://www.69shu.top/modules/article/bookcase.php*\r\n// #tag www.69shu.cx\r\n// @match        https://www.69shu.cx/txt/*/*\r\n// @match        https://www.69shu.cx/txt/*/end.html\r\n// @match        https://www.69shu.cx/book/*.htm*\r\n// @match        https://www.69shu.cx/modules/article/bookcase.php*\r\n// #tag 69shuba.cx\r\n// @match        https://69shuba.cx/txt/*/*\r\n// @match        https://69shuba.cx/txt/*/end.html\r\n// @match        https://69shuba.cx/book/*.htm*\r\n// @match        https://69shuba.cx/modules/article/bookcase.php*\r\n// #tag www.69shuba.pro\r\n// @match        https://www.69shuba.pro/txt/*/*\r\n// @match        https://www.69shuba.pro/txt/*/end.html\r\n// @match        https://www.69shuba.pro/book/*.htm*\r\n// @match        https://www.69shuba.pro/modules/article/bookcase.php*\r\n// #tag 69shuba.me\r\n// @match        https://69shu.me/txt/*/*\r\n// @match        https://69shu.me/txt/*/end.html\r\n// @match        https://69shu.me/book/*.htm*\r\n// @match        https://69shu.me/modules/article/bookcase.php*\r\n// #tag 69shu.biz\r\n// @match        https://69shu.biz/c/*/*\r\n// @match        https://69shu.biz/c/*/end.html\r\n// @match        https://69shu.biz/b/*.htm*\r\n// @match        https://69shu.biz/modules/article/bookcase.php*\r\n// #tag www.69yuedu.net\r\n// @match        https://www.69yuedu.net/r/*/*.html*\r\n// @match        https://www.69yuedu.net/article/*.html*\r\n// @match        https://www.69yuedu.net/modules/article/bookcase.php*\r\n// #tag www.69shuba.com\r\n// @match        https://www.69shuba.com/txt/*/*\r\n// @match        https://www.69shuba.com/modules/article/bookcase.php*\r\n// @match        https://www.69shuba.com/book/*.htm\r\n// #tag twkan.com\r\n// @match        https://twkan.com/txt/*/*\r\n// @match        https://twkan.com/bookcase*\r\n// @match        https://twkan.com/book/*.html\r\n\r\n// @icon         https://www.google.com/s2/favicons?sz=64&domain=69shuba.com\r\n// @grant        window.close\r\n// @grant        GM_addStyle\r\n// @grant        GM_getValue\r\n// @grant        GM_setValue\r\n// @grant        unsafeWindow\r\n// @grant        GM_registerMenuCommand\r\n// @grant        GM_openInTab\r\n// @grant        GM_getResourceText\r\n// @run-at       document-idle\r\n//#if debug\r\n// #@require file://C:\\Users\\p\\Documents\\git\\userjs\\Tools\\Tools.user.js\r\n//#else\r\n// @require https://github.com/Paul-16098/userjs/raw/dev/Tools/Tools.user.js\r\n//#endif\r\n\r\n// @resource     css1 https://github.com/Paul-16098/userjs/raw/refs/heads/dev/69shuba%20auto%20%E6%9B%B8%E7%B0%BD/69shuba%20auto%20%E6%9B%B8%E7%B0%BD.user.css\r\n// @resource     replace_json https://github.com/Paul-16098/userjs/raw/dev/69shuba%20auto%20%E6%9B%B8%E7%B0%BD/replace.json\r\n// @license      MIT\r\n// @supportURL   https://github.com/Paul-16098/userjs/issues/\r\n// @homepageURL  https://github.com/Paul-16098/userjs/README.md\r\n// ==/UserScript==\r\n\r\n// 語言選項枚舉\r\nenum Language {\r\n  en = \"en\",\r\n  zh = \"zh\",\r\n}\r\n\r\n/**\r\n * 用戶配置類，負責管理腳本的各項設置，並註冊菜單。\r\n */\r\nclass Config {\r\n  /** 是否開啟偵錯模式 */\r\n  Debug: boolean = GM_getValue(\"Debug\", false);\r\n  /** 結束頁是否自動關閉 */\r\n  IsEndClose: boolean = GM_getValue(\"IsEndClose\", true);\r\n  /** 是否自動加入書櫃 */\r\n  AutoAddBookcase: boolean = GM_getValue(\"AutoAddBookcase\", true);\r\n  /** 自動加入書櫃的封鎖名單（書ID陣列） */\r\n  AutoAddBookcaseBlockade: Array<string> = GM_getValue(\r\n    \"AutoAddBookcaseBlockade\",\r\n    []\r\n  );\r\n  /** 是否攔截alert */\r\n  IsHookAlert: boolean = GM_getValue(\"IsHookAlert\", true);\r\n  /** 攔截alert的訊息封鎖名單 */\r\n  HookAlertBlockade: Array<Array<any>> = GM_getValue(\"HookAlertBlockade\", [\r\n    [\"添加成功\"],\r\n    [\"刪除成功!\"],\r\n    [\"恭喜您，该章节已经加入到您的书签！\"],\r\n  ]);\r\n  /** 語言設定 */\r\n  Language: Language = GM_getValue(\"Language\", Language.zh);\r\n\r\n  constructor() {\r\n    this.set();\r\n    this.registerConfigMenu();\r\n    return this;\r\n  }\r\n  /**\r\n   * 註冊所有配置項的菜單\r\n   */\r\n  private registerConfigMenu() {\r\n    for (const key in this) {\r\n      const value = this[key as keyof Config];\r\n      let menu = undefined;\r\n      // 語言切換菜單\r\n      if (Object.values(Language).includes(value as Language)) {\r\n        menu = () => {\r\n          Object.values(Language).forEach((lang) => {\r\n            if (lang !== value) {\r\n              GM_setValue(\"Language\", lang);\r\n              location.reload();\r\n            }\r\n          });\r\n        };\r\n      }\r\n      setMenu(key, menu, value, {\r\n        zh: \"中文\",\r\n        en: \"english\",\r\n        Debug: \"偵錯\",\r\n        AutoAddBookcase: \"自動添加書櫃\",\r\n        AutoAddBookcaseBlockade: \"自動添加書櫃封鎖\",\r\n        Language: \"語言\",\r\n        IsEndClose: \"結束後關閉\",\r\n        IsHookAlert: \"掛鉤Alert\",\r\n        HookAlertBlockade: \"掛鉤Alert封鎖\",\r\n      });\r\n    }\r\n  }\r\n  /**\r\n   * 將當前配置寫入GM存儲\r\n   */\r\n  private set() {\r\n    GM_setValue(\"Debug\", this.Debug);\r\n    GM_setValue(\"IsEndClose\", this.IsEndClose);\r\n    GM_setValue(\"AutoAddBookcase\", this.AutoAddBookcase);\r\n    GM_setValue(\"AutoAddBookcaseBlockade\", this.AutoAddBookcaseBlockade);\r\n    GM_setValue(\"IsHookAlert\", this.IsHookAlert);\r\n    GM_setValue(\"HookAlertBlockade\", this.HookAlertBlockade);\r\n    GM_setValue(\"Language\", this.Language);\r\n  }\r\n}\r\n\r\n// 配置初始化\r\nconst config: Config = new Config();\r\n\r\n// i18n 設定\r\nconst i18nData: typeof i18n.prototype.langJson = {\r\n  en: {\r\n    noMatchingPattern: \"No matching URL pattern found\",\r\n    errorOccurred: \"An error occurred: \",\r\n    noLabelsFound: \"No labels found, retrying in 5 seconds...\",\r\n    maxRetriesReached: \"Max retries reached. No labels found.\",\r\n    noUpdates: \"No updates\",\r\n    updatesAvailable: \" updates available\",\r\n  },\r\n  zh: {\r\n    noMatchingPattern: \"未找到匹配的 URL 模式\",\r\n    errorOccurred: \"發生了一些錯誤: \",\r\n    noLabelsFound: \"未找到標籤，5 秒後重試...\",\r\n    maxRetriesReached: \"已達到最大重試次數。未找到標籤。\",\r\n    noUpdates: \"沒有更新\",\r\n    updatesAvailable: \"個更新\",\r\n  },\r\n};\r\n\r\n// 書籍數據接口\r\ninterface BookData {\r\n  Updata: {\r\n    url: {\r\n      value: string;\r\n      URLParams: URLSearchParams;\r\n    };\r\n  };\r\n  Mate: {\r\n    BookName: string;\r\n    BookHtmlObj: Element;\r\n    BookImgUrl: string;\r\n  };\r\n}\r\n\r\nconst i18nInstance = new i18n(i18nData, config.Language);\r\nconst t = i18nInstance.t;\r\n\r\n/**\r\n * `BookManager` 類別提供了各種方法來管理網頁上與書籍相關的資料並與之互動。\r\n * 它包括偵測圖書頁面、圖書資訊頁面、結束頁面和書架頁面的功能。\r\n * 它還提供了處理導航、將書籍添加到書架以及修改頁面元素的方法。\r\n *\r\n * @class\r\n * @classdesc 此類旨在自動化並增強與圖書相關的網站的使用者體驗。\r\n *\r\n * @property {Object} data -包含用於偵測和處理書籍相關頁面的各種方法和模式。\r\n * @property {Function} data.HasBookInfo  -檢查是否可用書籍信息。\r\n * @property {Function} data.IsBookshelf  -檢查當前頁面是否是書架頁面。\r\n * @property {Object} data.Book  -包含與書籍操作有關的方法。\r\n * @property {Function} data.Book.GetAid  -檢索書ID。\r\n * @property {Function} data.Book.GetCid  -檢索章節ID。\r\n * @property {RegExp} data.Book.pattern  -標識書頁的模式。\r\n * @property {Function} data.Book.Is  -檢查當前頁面是否是書頁。\r\n * @property {Object} data.Info  -包含與書籍信息操作有關的方法。\r\n * @property {RegExp} data.Info.pattern  -識別圖書信息頁面的模式。\r\n * @property {Function} data.Info.Is  -檢查當前頁面是否是書籍信息頁面。\r\n * @property {Object} data.End  -包含與最終頁面操作相關的方法。\r\n * @property {Function} data.End.Is  -檢查當前頁面是否是結束頁面。\r\n * @property {Function} data.GetNextPageUrl  -檢索下一頁的URL。\r\n * @property {Function} data.IsNextEnd  -檢查下一頁是否是終點頁面。\r\n * @property {Function} data.IsBiz  -檢查當前域是否為“ 69shu.biz”。\r\n *\r\n * @constructor\r\n * @description 初始化 `Bookmanager` 類的新實例。它註冊了配置菜單並處理不同類型的頁面（書籍, 書籍信息, 結束, 書架）。如果設置了 `config.debug` 標誌, 它還記錄了調試信息。\r\n * @throws 如果發生錯誤並且未設置 `config.debug` , 將提醒用户。\r\n *\r\n * @method handleBookPage\r\n * @description 透過執行各種修改和增強來處理書籍頁面。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method hookAlert\r\n * @description 掛鈎全域「警報」功能以有條件地阻止或記錄警報訊息。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method addStyles\r\n * @description 透過從指定資源注入 CSS 內容, 將自訂樣式新增至文件。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method modifyPageNavigation\r\n * @description 透過刪除現有的「onkeydown」事件處理程序並新增新的「keydown」事件偵聽器來修改頁面導航。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method keydownHandler\r\n * @description 處理鍵盤事件, 以便在按下「向右箭頭」鍵時導覽至下一頁。\r\n * @private\r\n * @param {KeyboardEvent} e -鍵盤事件物件。\r\n * @returns {void}\r\n *\r\n * @method addBookcase\r\n * @description 將當前的書添加到書架中。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method insertAuthorLink\r\n * @description 插入作者鏈接並用新鏈接替換標題DIV。\r\n * @private\r\n * @returns {void}\r\n *\r\n * @method handleBookshelf\r\n * @description 通過收集書籍數據和註冊菜單命令來處理書架。\r\n * @private\r\n * @returns {Promise<void>}\r\n *\r\n * @method collectBookData\r\n * @description 通過以 `book_` 開頭查詢ID, 從DOM收集書籍數據。\r\n * @private\r\n * @param {number} [retryCount=0]  -當前的重試計數。\r\n * @returns {Promise<BookData[]>}  -解決一系列收集的書籍數據的承諾。\r\n *\r\n * @method registerMenuCommand\r\n * @description 註冊菜單命令, 其中包含收集的書籍數據。\r\n * @private\r\n * @param {BookData[]} bookData  -收集的書籍數據。\r\n * @returns {void}\r\n *\r\n * @method debugInfo\r\n * @description 收集和返回調試信息。\r\n * @private\r\n * @returns {Object}  -調試信息。\r\n *\r\n * @method registerConfigMenu\r\n * @description 註冊配置菜單。\r\n * @private\r\n * @returns {void}\r\n */\r\nclass BookManager {\r\n  /** 常用選擇器集合 */\r\n  SELECTORS = {\r\n    nextPage: [\r\n      \"body > div.container > div.mybox > div.page1 > a:nth-child(4)\",\r\n      \"body > div.mainbox > div > div.page1 > a:nth-child(4)\",\r\n    ],\r\n    authorInfo:\r\n      \"body > div.container > div.mybox > div.txtnav > div.txtinfo.hide720 > span:nth-child(2)\",\r\n    titleDiv: \"body > div.container > div.mybox > div.tools\",\r\n    searchInput:\r\n      \"body > header > div > form > div > div.inputbox > input[type=text]\",\r\n    searchForm: \"body > header > div > form\",\r\n  };\r\n  /**\r\n   * 各種頁面判斷與數據獲取方法集合\r\n   */\r\n  private data = {\r\n    // 判斷是否有書籍信息\r\n    HasBookInfo: typeof bookinfo !== \"undefined\",\r\n    // 判斷是否在書架頁面\r\n    IsBookshelf: (href: string = location.href) => {\r\n      if (this.data.IsTwkan) {\r\n        return new URL(href).pathname === \"/bookcase\";\r\n      } else {\r\n        return new URL(href).pathname === \"/modules/article/bookcase.php\";\r\n      }\r\n    },\r\n    // 書籍相關操作\r\n    Book: {\r\n      // 獲取書籍ID\r\n      GetAid: (href: string = window.location.href) => {\r\n        if (this.data.HasBookInfo) {\r\n          return bookinfo.articleid;\r\n        }\r\n        return href.split(\"/\")[4];\r\n      },\r\n      // 獲取章節ID\r\n      GetCid: (href: string = window.location.href) => {\r\n        if (this.data.HasBookInfo) {\r\n          return bookinfo.chapterid;\r\n        }\r\n        return href.split(\"/\")[5];\r\n      },\r\n      // 書籍URL模式\r\n      pattern: /^\\/(txt|c|r)\\/([0-9]|[a-z])+\\/([0-9]|[a-z])+(\\.html)?$/m,\r\n      // 判斷是否為書籍頁面\r\n      Is: (href: string = window.location.href) => {\r\n        return this.data.Book.pattern.test(new URL(href).pathname);\r\n      },\r\n    },\r\n    // 書籍信息相關操作\r\n    Info: {\r\n      // 書籍信息URL模式\r\n      pattern: /^\\/(book|b|article)\\/([0-9]|[a-z])+\\.htm(l)?$/m,\r\n      // 判斷是否為書籍信息頁面\r\n      Is: (pathname: string = window.location.pathname) => {\r\n        return this.data.Info.pattern.test(pathname);\r\n      },\r\n    },\r\n    // 結束頁面相關操作\r\n    End: {\r\n      // 判斷是否為結束頁面\r\n      Is: (href: string = window.location.href) => {\r\n        if (this.data.Info.Is()) {\r\n          const searchParams = new URL(href).searchParams;\r\n          return searchParams.get(\"FromBook\") === \"true\";\r\n        }\r\n        if (this.data.IsTwkan) {\r\n          let h = new URL(href);\r\n          if (\r\n            /txt\\/[0-9]+\\/end\\.html/.test(h.pathname) &&\r\n            h.searchParams.get(\"FromBook\") === \"true\"\r\n          ) {\r\n            return true;\r\n          } else {\r\n            return false;\r\n          }\r\n        }\r\n        return false;\r\n      },\r\n    },\r\n    // 獲取下一頁URL\r\n    GetNextPageUrl: () => {\r\n      const nextPageEle = this.getNextPageElement();\r\n      return nextPageEle?.href;\r\n    },\r\n    // 判斷下一頁是否為結束頁面\r\n    IsNextEnd: () => {\r\n      if (this.data.Book.Is()) {\r\n        const nextUrl = this.data.GetNextPageUrl();\r\n        if (nextUrl) {\r\n          return (\r\n            this.data.End.Is(nextUrl) ||\r\n            this.data.Info.Is(new URL(nextUrl).pathname)\r\n          );\r\n        }\r\n      }\r\n      return false;\r\n    },\r\n    // 判斷是否為69shu.biz域名\r\n    IsBiz: location.host === \"69shu.biz\",\r\n    // 判斷是否為twkan.com域名\r\n    IsTwkan: location.host === \"twkan.com\",\r\n  };\r\n\r\n  /**\r\n   * 取得下一頁的a元素\r\n   */\r\n  getNextPageElement(): HTMLAnchorElement | null {\r\n    for (const selector of this.SELECTORS.nextPage) {\r\n      const element = document.querySelector(\r\n        selector\r\n      ) as HTMLAnchorElement | null;\r\n      if (element && element.href) return element;\r\n    }\r\n    // 備用方案：尋找文字為\"下一章\"的連結\r\n    return Array.from(document.querySelectorAll(\"a\")).find(\r\n      (link) => link.textContent === \"下一章\"\r\n    ) as HTMLAnchorElement | null;\r\n  }\r\n\r\n  /**\r\n   * 構造函數，根據當前頁面自動分派對應處理\r\n   */\r\n  constructor() {\r\n    try {\r\n      if (config.Debug) {\r\n        console.debug(this.debugInfo());\r\n      }\r\n\r\n      // #tag search\r\n      const search = new URLSearchParams(location.search).get(\"q\");\r\n      if (search) this.performSearch(search);\r\n\r\n      // #tag BookEnd\r\n      if (this.data.End.Is()) {\r\n        if (config.Debug) console.log(\"End page detected\");\r\n        if (config.IsEndClose) window.close();\r\n      }\r\n      // #tag Book\r\n      if (this.data.Book.Is()) {\r\n        if (config.Debug) console.log(\"Book page detected\");\r\n        this.handleBookPage();\r\n      }\r\n      // #tag Info\r\n      if (this.data.Info.Is()) {\r\n        if (config.Debug) console.log(\"Book info page detected\");\r\n        let Ele = document.querySelector(\r\n          \"body > div.container > ul > li.col-8 > div:nth-child(2) > ul > li:nth-child(2) > a\"\r\n        ) as HTMLAnchorElement | null;\r\n        if (Ele) {\r\n          Ele.click();\r\n        }\r\n      }\r\n      // #tag Bookshelf\r\n      if (this.data.IsBookshelf()) {\r\n        if (config.Debug) console.log(\"Bookshelf page detected\");\r\n        this.handleBookshelf();\r\n      }\r\n\r\n      // if not match any pattern\r\n      if (\r\n        !this.data.Book.Is() &&\r\n        !this.data.Info.Is() &&\r\n        !this.data.End.Is() &&\r\n        !this.data.IsBookshelf()\r\n      ) {\r\n        if (!config.Debug) {\r\n          alert(t(\"noMatchingPattern\"));\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(error);\r\n      if (!config.Debug) {\r\n        alert(`${t(\"errorOccurred\")}${String(error)}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 書頁自動化處理：樣式、導航、元素移除、書櫃、作者連結、下一頁鏈接\r\n   */\r\n  private handleBookPage(): void {\r\n    if (config.IsHookAlert) this.hookAlert();\r\n    this.addStyles();\r\n    this.modifyPageNavigation();\r\n    removeElement(\r\n      \".mytitle\",\r\n      \".top_Scroll\",\r\n      \"#pagefootermenu\",\r\n      \"body > div.container > div > div.yueduad1\",\r\n      \"#pageheadermenu\",\r\n      \".bottom-ad2\",\r\n      \"body > div.container > div.yuedutuijian.light\"\r\n    );\r\n    if (this.data.IsTwkan) {\r\n      removeElement(\"#container > br\");\r\n    }\r\n    if (config.AutoAddBookcase) this.autoAddToBookcase();\r\n    this.insertAuthorLink();\r\n    this.updateNextPageLink();\r\n    if (this.data.IsTwkan) {\r\n      const raw_replace_json = GM_getResourceText(\"replace_json\");\r\n      let replace_json: {\r\n        [key: string]: string;\r\n      } = {};\r\n      try {\r\n        replace_json = JSON.parse(raw_replace_json);\r\n      } catch (error) {\r\n        if (error instanceof SyntaxError) {\r\n          if (config.Debug) {\r\n            console.log(error);\r\n          } else {\r\n            alert(error);\r\n          }\r\n        } else {\r\n          throw error;\r\n        }\r\n      }\r\n      if (config.Debug) {\r\n        console.log(\"replace_json: \", replace_json);\r\n      }\r\n\r\n      for (const key in replace_json) {\r\n        if (Object.prototype.hasOwnProperty.call(replace_json, key)) {\r\n          const element = replace_json[key];\r\n          (document.querySelector(\"#txtcontent\") as HTMLDivElement).innerText =\r\n            (\r\n              document.querySelector(\"#txtcontent\") as HTMLDivElement\r\n            )?.innerText.replaceAll(key, element);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 自動加入書櫃（如未在封鎖名單）\r\n   */\r\n  private autoAddToBookcase(): void {\r\n    const aid = this.data.Book.GetAid();\r\n    if (!config.AutoAddBookcaseBlockade.includes(aid)) {\r\n      this.addBookcase();\r\n    } else {\r\n      console.log(\"Book is in the blockade list, not auto adding to bookcase.\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 更新下一頁鏈接，附加FromBook參數\r\n   */\r\n  private updateNextPageLink(): void {\r\n    const nextPageEle = this.getNextPageElement();\r\n    if (nextPageEle) {\r\n      const href = new URL(nextPageEle.href);\r\n      href.searchParams.set(\"FromBook\", \"true\");\r\n      nextPageEle.href = href.toString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 攔截全局alert，根據封鎖名單過濾\r\n   */\r\n  private hookAlert(): void {\r\n    const _alert: Function = alert;\r\n    unsafeWindow.alert = (...message: any) => {\r\n      if (\r\n        !config.HookAlertBlockade.some(\r\n          (blockade) =>\r\n            JSON.stringify(message) === JSON.stringify(blockade) ||\r\n            JSON.stringify(blockade) === \"*\"\r\n        )\r\n      ) {\r\n        _alert(...message);\r\n      }\r\n      if (config.Debug) console.log(\"Alert message:\", message);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 注入自定義CSS樣式\r\n   */\r\n  private addStyles(): void {\r\n    const css1 = GM_getResourceText(\"css1\");\r\n    GM_addStyle(css1);\r\n    if (config.Debug) console.log(\"CSS added\");\r\n  }\r\n\r\n  /**\r\n   * 移除原有onkeydown，註冊自定義鍵盤導航\r\n   */\r\n  private modifyPageNavigation(): void {\r\n    document.onkeydown = null;\r\n    addEventListener(\"keydown\", this.keydownHandler.bind(this));\r\n  }\r\n\r\n  /**\r\n   * 處理右鍵導航與結束自動關閉\r\n   */\r\n  private keydownHandler(e: KeyboardEvent): void {\r\n    if (!e.repeat && e.key === \"ArrowRight\") {\r\n      const nextPageLink = this.data.GetNextPageUrl();\r\n      if (nextPageLink) {\r\n        let href = new URL(nextPageLink);\r\n        href.searchParams.set(\"FromBook\", \"true\");\r\n        window.location.href = href.toString();\r\n      }\r\n      if (this.data.IsNextEnd()) {\r\n        if (config.IsEndClose) {\r\n          window.close();\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 加入書櫃（根據不同站點呼叫不同API或模擬點擊）\r\n   */\r\n  private addBookcase(): void {\r\n    const aid = this.data.Book.GetAid();\r\n    const cid = this.data.Book.GetCid();\r\n    if (!addbookcase.toString().includes(\"Ajax.Tip\")) {\r\n      addbookcase(aid, cid);\r\n    } else {\r\n      const addBookcaseLink = document.querySelector(\r\n        \"#a_addbookcase\"\r\n      ) as HTMLElement | null;\r\n      addBookcaseLink?.click();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 替換標題div為帶有作者連結的新元素\r\n   */\r\n  private insertAuthorLink(): void {\r\n    const author =\r\n      document\r\n        .querySelector(this.SELECTORS.authorInfo)\r\n        ?.textContent?.trim()\r\n        .split(\" \")[1] ?? \"undefined\";\r\n    const authorLink = this.createAuthorLink(author);\r\n    const titleDiv = document.querySelector(\r\n      this.SELECTORS.titleDiv\r\n    ) as HTMLDivElement;\r\n    if (titleDiv) {\r\n      const titleLink = this.createTitleLink();\r\n      titleDiv.parentNode?.replaceChild(titleLink, titleDiv);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 建立作者頁面連結元素\r\n   */\r\n  private createAuthorLink(author: string): HTMLAnchorElement {\r\n    const authorLink = document.createElement(\"a\");\r\n    authorLink.href = `${\r\n      window.location.origin\r\n    }/modules/article/author.php?author=${encodeURIComponent(author)}`;\r\n    authorLink.textContent = author;\r\n    authorLink.style.color = \"#007ead\";\r\n    return authorLink;\r\n  }\r\n\r\n  /**\r\n   * 建立書名連結元素\r\n   */\r\n  private createTitleLink(): HTMLAnchorElement {\r\n    const titleLink = document.createElement(\"a\");\r\n    titleLink.innerHTML = this.data.HasBookInfo\r\n      ? bookinfo.articlename ?? document.title.split(\"-\")[0]\r\n      : document.title.split(\"-\")[0];\r\n    titleLink.classList.add(\"userjs_add\");\r\n    titleLink.id = \"title\";\r\n    titleLink.href = `${window.location.origin}/${\r\n      this.data.IsBiz ? \"b\" : \"book\"\r\n    }/${this.data.Book.GetAid()}.${\r\n      this.data.IsBiz || this.data.IsTwkan ? \"html\" : \"htm\"\r\n    }`;\r\n    return titleLink;\r\n  }\r\n\r\n  /**\r\n   * 書架頁面：收集書籍資料並註冊菜單\r\n   */\r\n  private async handleBookshelf(): Promise<void> {\r\n    const bookData = await this.collectBookData();\r\n    if (config.Debug) console.log(\"Bookshelf data collected\", bookData);\r\n    this.registerMenuCommand(bookData);\r\n  }\r\n\r\n  /**\r\n   * 搜尋功能：自動填入並提交表單\r\n   */\r\n  private performSearch(search: string): void {\r\n    const searchInput = document.querySelector(\r\n      this.SELECTORS.searchInput\r\n    ) as HTMLInputElement;\r\n    const searchForm = document.querySelector(\r\n      this.SELECTORS.searchForm\r\n    ) as HTMLFormElement;\r\n    if (searchInput && searchForm) {\r\n      searchInput.value = search;\r\n      searchForm.submit();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 遞迴收集書架書籍資料，最多重試5次\r\n   */\r\n  private async collectBookData(retryCount: number = 0): Promise<BookData[]> {\r\n    const books: Array<BookData> = [];\r\n    const labels = document.querySelectorAll(\"[id^='book_']\");\r\n    if (config.Debug) console.groupCollapsed(\"collectBookData\");\r\n    if (labels.length === 0) {\r\n      if (retryCount <= 5) {\r\n        console.warn(t(\"noLabelsFound\"));\r\n        await new Promise((resolve) => setTimeout(resolve, 5000));\r\n        return this.collectBookData(retryCount + 1);\r\n      } else {\r\n        console.error(t(\"maxRetriesReached\"));\r\n        return []; // 到達最大重試次數, 返回空陣列\r\n      }\r\n    }\r\n    if (config.Debug) {\r\n      console.log(labels);\r\n    }\r\n    labels.forEach((label) => {\r\n      const bookContainer = label;\r\n\r\n      const tmp = (function () {\r\n        if (\r\n          Array.from(label.querySelectorAll(\"label\")).find(\r\n            (label2) => label2.textContent === \"更新\"\r\n          )\r\n        ) {\r\n          // if (location.origin === \"https://www.69yuedu.net\") {\r\n          // } else {\r\n          const bookContinueEle = label.querySelector(\r\n            \"div.newright > a.btn.btn-tp\"\r\n          ) as HTMLAnchorElement;\r\n          const bookContinueLink = bookContinueEle.href;\r\n\r\n          const BookName = (\r\n            label.querySelector(\"div.newnav > h3 > a > span\") as HTMLSpanElement\r\n          ).textContent as string;\r\n\r\n          const bookImgEle = label.querySelector(\"a > img\") as HTMLImageElement;\r\n          const bookImgUrl = bookImgEle.src;\r\n          // }\r\n          return { bookContinueLink, BookName, bookImgUrl };\r\n        } else {\r\n          return false;\r\n        }\r\n      })();\r\n      if (tmp) {\r\n        const { bookContinueLink, BookName, bookImgUrl } = tmp;\r\n\r\n        const push_data: BookData = {\r\n          Updata: {\r\n            url: {\r\n              value: bookContinueLink,\r\n              URLParams: new URLSearchParams(bookContinueLink),\r\n            },\r\n          },\r\n          Mate: {\r\n            BookName: BookName,\r\n            BookHtmlObj: bookContainer,\r\n            BookImgUrl: bookImgUrl,\r\n          },\r\n        };\r\n        if (config.Debug) {\r\n          console.group(push_data.Mate.BookName);\r\n          console.log(push_data.Mate);\r\n          console.table(push_data.Updata);\r\n          console.groupEnd();\r\n        }\r\n\r\n        books.push(push_data);\r\n      }\r\n    });\r\n    if (config.Debug) console.groupEnd();\r\n    return books;\r\n  }\r\n\r\n  /**\r\n   * 註冊菜單命令，點擊可批量打開所有更新書籍\r\n   */\r\n  private registerMenuCommand(bookData: BookData[]) {\r\n    GM_registerMenuCommand(\r\n      `${\r\n        bookData.length === 0\r\n          ? t(\"noUpdates\")\r\n          : `${bookData.length}${t(\"updatesAvailable\")}`\r\n      }`,\r\n      () => {\r\n        bookData.forEach((data) => {\r\n          GM_openInTab(data.Updata.url.value);\r\n        });\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * 輸出調試資訊\r\n   */\r\n  private debugInfo() {\r\n    return {\r\n      IsBook: this.data.Book.Is(),\r\n      IsInfo: this.data.Info.Is(),\r\n      IsEnd: this.data.End.Is(),\r\n      IsNextEnd: this.data.IsNextEnd(),\r\n      IsBookshelf: this.data.IsBookshelf(),\r\n      HasBookinfo: this.data.HasBookInfo,\r\n      IsBiz: this.data.IsBiz,\r\n      IsTwkan: this.data.IsTwkan,\r\n      ...config,\r\n    };\r\n  }\r\n}\r\n\r\n// 初始化書籍管理器\r\nconst bookManager = new BookManager();\r\n"],"names":["Language","Config","Debug","GM_getValue","IsEndClose","AutoAddBookcase","AutoAddBookcaseBlockade","IsHookAlert","HookAlertBlockade","set","registerConfigMenu","key","value","menu","undefined","Object","values","includes","forEach","lang","GM_setValue","location","reload","setMenu","zh","en","config","i18nData","noMatchingPattern","errorOccurred","noLabelsFound","maxRetriesReached","noUpdates","updatesAvailable","i18nInstance","i18n","t","BookManager","SELECTORS","nextPage","authorInfo","titleDiv","searchInput","searchForm","data","HasBookInfo","bookinfo","IsBookshelf","href","IsTwkan","URL","pathname","Book","GetAid","window","articleid","split","GetCid","chapterid","pattern","Is","test","Info","End","searchParams","get","h","GetNextPageUrl","nextPageEle","getNextPageElement","IsNextEnd","nextUrl","IsBiz","host","selector","element","document","querySelector","Array","from","querySelectorAll","find","link","textContent","console","debug","debugInfo","search","URLSearchParams","performSearch","log","close","handleBookPage","Ele","click","handleBookshelf","alert","error","String","hookAlert","addStyles","modifyPageNavigation","removeElement","autoAddToBookcase","insertAuthorLink","updateNextPageLink","raw_replace_json","GM_getResourceText","replace_json","JSON","parse","SyntaxError","prototype","hasOwnProperty","call","innerText","replaceAll","aid","addBookcase","toString","_alert","unsafeWindow","message","some","blockade","stringify","css1","GM_addStyle","onkeydown","addEventListener","keydownHandler","bind","e","repeat","nextPageLink","cid","addbookcase","addBookcaseLink","author","trim","authorLink","createAuthorLink","titleLink","createTitleLink","parentNode","replaceChild","createElement","origin","encodeURIComponent","style","color","innerHTML","articlename","title","classList","add","id","bookData","collectBookData","registerMenuCommand","submit","retryCount","books","labels","groupCollapsed","length","warn","Promise","resolve","setTimeout","label","bookContainer","tmp","label2","bookContinueEle","bookContinueLink","BookName","bookImgEle","bookImgUrl","src","push_data","Updata","url","URLParams","Mate","BookHtmlObj","BookImgUrl","group","table","groupEnd","push","GM_registerMenuCommand","GM_openInTab","IsBook","IsInfo","IsEnd","HasBookinfo","bookManager"],"mappings":"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"}